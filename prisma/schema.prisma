// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum UserRole {
  FACULTY_ADMIN
  DEPARTMENTAL_OFFICER
  LECTURER
  COURSE_REP
}

enum AssetStatus {
  AVAILABLE
  ALLOCATED
  MAINTENANCE
  RETIRED
  TRANSFER_PENDING
}

enum AssetType {
  CONSUMABLE
  TEACHING_AID
  EQUIPMENT
  FURNITURE
  OTHER
}

enum AssetCategory {
  RETURNABLE
  CONSUMABLE
  EXPIRABLE
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  FULFILLED
  RETURNED
}

enum TransferStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  role          UserRole
  department    String?
  employeeId    String?   @unique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  registeredAssets Asset[] @relation("RegisteredAssets")
  allocatedAssets Asset[] @relation("AllocatedAssets")
  requests      Request[]
  issuedRequests Request[] @relation("IssuedRequests")
  verifiedReturns Request[] @relation("VerifiedReturns")
  transfers    Transfer[] @relation("TransferFrom")
  receivedTransfers Transfer[] @relation("TransferTo")
  approvals     Approval[]
  notifications Notification[]
}

model Asset {
  id            String      @id @default(cuid())
  name          String
  description   String?
  assetCode     String      @unique
  type          AssetType
  status        AssetStatus @default(AVAILABLE)
  category      String?
  assetCategory AssetCategory?
  location      String?
  room          String?
  purchaseDate  DateTime?
  purchasePrice Float?
  serialNumber  String?
  manufacturer  String?
  model         String?
  expiryDate    DateTime?
  documentUrls  String?     // JSON array of document URLs
  isArchived    Boolean     @default(false)
  archivedAt    DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  registeredBy  String
  registeredByUser User     @relation("RegisteredAssets", fields: [registeredBy], references: [id])
  allocatedTo  String?
  allocatedToUser User?     @relation("AllocatedAssets", fields: [allocatedTo], references: [id])
  requests     Request[]
  transfers    Transfer[]
}

model Request {
  id            String        @id @default(cuid())
  assetId       String
  asset         Asset         @relation(fields: [assetId], references: [id])
  requestedBy   String
  requestedByUser User        @relation(fields: [requestedBy], references: [id])
  status        RequestStatus @default(PENDING)
  purpose       String?
  requestedAt   DateTime      @default(now())
  approvedAt    DateTime?
  fulfilledAt   DateTime?
  returnedAt    DateTime?
  notes         String?
  // Issuance tracking
  issuedBy      String?
  issuedByUser  User?         @relation("IssuedRequests", fields: [issuedBy], references: [id])
  issuedAt      DateTime?
  issuanceCondition String?   // e.g., "FUNCTIONAL", "DAMAGED", "GOOD"
  issuanceNotes String?
  // Return tracking
  returnCondition String?     // e.g., "FUNCTIONAL", "DAMAGED", "LOST", "NEEDS_REPAIR"
  returnNotes    String?
  verifiedBy     String?
  verifiedByUser User?        @relation("VerifiedReturns", fields: [verifiedBy], references: [id])
  verifiedAt     DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  approvals     Approval[]
}

model Notification {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  type          String    // "REQUEST_APPROVED", "REQUEST_REJECTED", "REQUEST_FULFILLED", "ASSET_RETURNED"
  title         String
  message       String
  relatedRequestId String?
  relatedRequest Request? @relation(fields: [relatedRequestId], references: [id])
  read          Boolean   @default(false)
  createdAt     DateTime  @default(now())
}

model Transfer {
  id            String          @id @default(cuid())
  assetId       String
  asset         Asset           @relation(fields: [assetId], references: [id])
  fromUserId    String
  fromUser      User            @relation("TransferFrom", fields: [fromUserId], references: [id])
  toUserId      String
  toUser        User            @relation("TransferTo", fields: [toUserId], references: [id])
  status        TransferStatus  @default(PENDING)
  reason        String?
  requestedAt   DateTime        @default(now())
  approvedAt    DateTime?
  completedAt   DateTime?
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  approvals     Approval[]
}

model Approval {
  id            String    @id @default(cuid())
  requestId     String?
  request       Request?  @relation(fields: [requestId], references: [id])
  transferId    String?
  transfer      Transfer? @relation(fields: [transferId], references: [id])
  approvedBy    String
  approvedByUser User     @relation(fields: [approvedBy], references: [id])
  status        String    // APPROVED or REJECTED
  comments      String?
  approvedAt    DateTime  @default(now())
  createdAt     DateTime  @default(now())
}
